<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>"Perlito" MiniPerl6 Compiler</title>
	</head>
	<body>
    <h1>"Perlito" MiniPerl6 Compiler</h1>
        <script type="text/javascript" src="perlito.js"></script>

        <p>Source program:</p>
		<textarea id="source" cols="70" rows="10">
class Main {
  say "hello, World!"
}
</textarea><br/>
		<input type="button" value="Execute" onclick="execute()"/>

        <p>Compiler log:</p>
		<textarea id="log-result" readonly="true" cols="70" rows="5"></textarea><br/>

        <p>Syntax tree (AST):</p>
		<textarea id="ast-result" readonly="true" cols="70" rows="5"></textarea><br/>

        <p>Compiled to Javascript:</p>
		<textarea id="js-result" readonly="true" cols="70" rows="5"></textarea><br/>

        <p>Output:</p>
		<textarea id="print-result" readonly="true" cols="70" rows="5"></textarea><br/>

	<script>

        function print(s) {
			document.getElementById('print-result').value += s;
        }

		function execute() {
			var source = document.getElementById('source').value;
            var pos = 0;
            var ast;
            var match;
			document.getElementById('log-result').value   = "";
			document.getElementById('ast-result').value   = "";
			document.getElementById('js-result').value    = "";
		    document.getElementById('print-result').value = "";
            try {
                // compile
			    document.getElementById('log-result').value += "Compiling.\n";
                var start = new Date().getTime();
		    	document.getElementById('js-result').value += "// Do not edit this file - Generated by MiniPerl6\n";
                while ( pos < source.length ) {
                    // compilation unit
                    match = MiniPerl6$Grammar.f_comp_unit(source, pos);
                    ast = match.f_scalar();
		    	    document.getElementById('ast-result').value += ast.f_perl() + ";\n";
		    	    document.getElementById('log-result').value += "Emitting javascript.\n";
		    	    document.getElementById('js-result').value += ast.f_emit() + "\n";
                    pos = match.v_to;
			        document.getElementById('log-result').value += 
                        "Finished compilation unit at pos " + pos + " of " + source.length + "\n";
                }
                // run
		    	eval(document.getElementById('js-result').value);
                // report
                var end = new Date().getTime();
                var time = end - start;
			    document.getElementById('log-result').value += "Time: " + (time/1000) + "s\n";
                print("Done.\n");
            }
            catch(err) {
                document.getElementById('log-result').value += "Error:\n";
                document.getElementById('log-result').value += f_perl(err) + "\n";
                document.getElementById('log-result').value += "Compilation aborted.\n";
            }
		}
	</script>
	</body>
</html>
